apiVersion: batch/v1
kind: Job
metadata:
  name: irsa-verify-test
  namespace: default
  annotations:
    description: "Test job to verify IRSA (IAM Role for Service Accounts) is working correctly"
spec:
  ttlSecondsAfterFinished: 300  # Clean up after 5 minutes
  template:
    spec:
      serviceAccountName: clearinghouse-app
      restartPolicy: Never
      containers:
      - name: aws-cli-test
        image: amazon/aws-cli:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "=========================================="
          echo "IRSA Verification Test"
          echo "=========================================="
          echo ""
          
          # Test 1: Verify AWS credentials are available
          echo "Test 1: Checking AWS credentials..."
          if [ -n "$AWS_ROLE_ARN" ] && [ -n "$AWS_WEB_IDENTITY_TOKEN_FILE" ]; then
            echo "✓ IRSA environment variables are set:"
            echo "  AWS_ROLE_ARN: $AWS_ROLE_ARN"
            echo "  AWS_WEB_IDENTITY_TOKEN_FILE: $AWS_WEB_IDENTITY_TOKEN_FILE"
          else
            echo "✗ IRSA environment variables not found!"
            echo "  AWS_ROLE_ARN: ${AWS_ROLE_ARN:-not set}"
            echo "  AWS_WEB_IDENTITY_TOKEN_FILE: ${AWS_WEB_IDENTITY_TOKEN_FILE:-not set}"
            exit 1
          fi
          
          echo ""
          echo "Test 2: Verifying AWS identity..."
          IDENTITY=$(aws sts get-caller-identity 2>&1)
          if [ $? -eq 0 ]; then
            echo "✓ Successfully assumed IAM role:"
            echo "$IDENTITY" | jq '.'
            ROLE_ARN=$(echo "$IDENTITY" | jq -r '.Arn')
            echo ""
            echo "  Assumed Role ARN: $ROLE_ARN"
          else
            echo "✗ Failed to assume IAM role:"
            echo "$IDENTITY"
            exit 1
          fi
          
          echo ""
          echo "Test 3: Testing S3 access..."
          S3_BUCKET="gringotts-clearinghouse-dev-raw-641332413762"
          
          # List bucket
          echo "Attempting to list S3 bucket: s3://$S3_BUCKET"
          if aws s3 ls "s3://$S3_BUCKET" 2>&1; then
            echo ""
            echo "✓ Successfully listed S3 bucket!"
          else
            S3_ERROR=$?
            echo ""
            echo "✗ Failed to list S3 bucket (exit code: $S3_ERROR)"
            echo ""
            echo "Checking permissions..."
            aws s3api get-bucket-location --bucket "$S3_BUCKET" 2>&1 || true
            exit 1
          fi
          
          echo ""
          echo "Test 4: Testing S3 write permission..."
          TEST_KEY="irsa-test-$(date +%s).txt"
          TEST_CONTENT="IRSA verification test - $(date)"
          
          if echo "$TEST_CONTENT" | aws s3 cp - "s3://$S3_BUCKET/$TEST_KEY" 2>&1; then
            echo "✓ Successfully wrote test file to S3: s3://$S3_BUCKET/$TEST_KEY"
            
            # Clean up test file
            echo "Cleaning up test file..."
            aws s3 rm "s3://$S3_BUCKET/$TEST_KEY" 2>&1 && echo "✓ Test file deleted" || echo "⚠ Could not delete test file"
          else
            WRITE_ERROR=$?
            echo "✗ Failed to write to S3 (exit code: $WRITE_ERROR)"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "✓ All IRSA tests passed!"
          echo "=========================================="
          echo ""
          echo "Summary:"
          echo "  - IRSA environment variables: ✓"
          echo "  - IAM role assumption: ✓"
          echo "  - S3 list permission: ✓"
          echo "  - S3 write permission: ✓"
          echo ""
          echo "IRSA is correctly configured and working!"
        env:
        - name: AWS_REGION
          value: "us-west-2"
        - name: AWS_DEFAULT_REGION
          value: "us-west-2"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "200m"
            memory: "256Mi"

